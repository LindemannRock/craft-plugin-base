{#
 # CP Table Layout
 #
 # A reusable layout for Control Panel pages displaying tabular data.
 # Provides unified toolbar, table, pagination, and optional AJAX refresh.
 #
 # Usage in plugin template:
 # ┌──────────────────────────────────────────────────────────────────┐
 # │ {% extends 'lindemannrock-base/_layouts/cp-table' %}            │
 # │                                                                  │
 # │ {% set tableConfig = {                                          │
 # │     plugin: {                                                   │
 # │         handle: 'sms-manager',                                  │
 # │         name: smsHelper.fullName,                               │
 # │     },                                                          │
 # │     page: {                                                     │
 # │         title: 'SMS Logs',                                      │
 # │         subnav: 'sms-logs',                                     │
 # │         crumbs: [...],                                          │
 # │     },                                                          │
 # │     filters: [...],                                             │
 # │     search: {placeholder: 'Search logs...', value: search},     │
 # │     table: {                                                    │
 # │         columns: [                                              │
 # │             {key: 'name', label: 'Name', sortable: true},       │
 # │             {key: 'email', label: 'Email', hideable: true},     │
 # │             {key: 'status', label: 'Status', hideable: true},   │
 # │         ],                                                      │
 # │         items: logs,                                            │
 # │         emptyMessage: 'No logs found.',                         │
 # │         expandable: true,  // Enable click-to-expand rows       │
 # │     },                                                          │
 # │     pagination: {                                               │
 # │         page: page,                                             │
 # │         limit: settings.itemsPerPage,                           │
 # │         totalCount: totalCount,                                 │
 # │         itemLabel: {singular: 'log', plural: 'logs'},           │
 # │     },                                                          │
 # │     checkboxes: true,                                           │
 # │     footerActions: [...],                                       │
 # │     newButton: {url: '...', label: '...', permission: '...'},   │
 # │     ajax: {                                                     │
 # │         enabled: settings.refreshIntervalSecs > 0,              │
 # │         interval: settings.refreshIntervalSecs,                 │
 # │         endpoint: 'sms-manager/logs/get-data',                  │
 # │     },                                                          │
 # │ } %}                                                            │
 # └──────────────────────────────────────────────────────────────────┘
 #
 # Overridable blocks:
 # - {% block beforeTable %} - Content before table (warnings, info boxes)
 # - {% block tableRow %} - Custom row rendering
 # - {% block rowActions %} - Per-row action buttons
 # - {% block expandableRow %} - Expandable detail row (logs, etc.)
 # - {% block bulkActions %} - Bulk action buttons (shown when items selected)
 # - {% block sidebarContent %} - Right sidebar/details pane content
 # - {% block toolbarActions %} - Toolbar action buttons (export, etc.)
 # - {% block extraToolbar %} - Additional toolbar items inside toolbar
 # - {% block extraFooter %} - Additional footer content
 # - {% block scripts %} - Additional JavaScript
 #}

{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{# ============================================================================
   CONFIGURATION EXTRACTION
   ============================================================================ #}

{% set config = tableConfig ?? {} %}

{# Plugin info #}
{% set pluginConfig = config.plugin ?? {} %}
{% set pluginHandle = pluginConfig.handle ?? '' %}
{% set pluginName = pluginConfig.name ?? '' %}

{# Page info #}
{% set pageConfig = config.page ?? {} %}
{% set title = pageConfig.title ?? 'Listing' %}
{% set selectedSubnavItem = pageConfig.subnav ?? '' %}
{% set crumbs = pageConfig.crumbs ?? [] %}
{% set fullPageForm = pageConfig.fullPageForm ?? false %}

{# Filters #}
{% set filters = config.filters ?? [] %}

{# Search #}
{% set searchConfig = config.search ?? {} %}
{% set searchPlaceholder = searchConfig.placeholder ?? 'Search...'|t('app') %}
{% set searchValue = searchConfig.value ?? craft.app.request.getParam('search', '') %}

{# Sorting - get from config or URL #}
{% set sortConfig = config.sort ?? {} %}
{% set currentSort = sortConfig.field ?? craft.app.request.getParam('sort', 'dateCreated') %}
{% set currentDir = sortConfig.direction ?? craft.app.request.getParam('dir', 'desc') %}

{# Table #}
{% set tableConf = config.table ?? {} %}
{% set columns = tableConf.columns ?? [] %}
{% set items = tableConf.items ?? [] %}
{% set emptyMessage = tableConf.emptyMessage ?? 'No items found.'|t('app') %}
{% set expandableEnabled = tableConf.expandable ?? false %}

{# View button configuration - only enabled when there are hideable columns #}
{% set hideableColumns = columns|filter(c => c.hideable ?? false) %}
{% set sortableColumns = columns|filter(c => c.sortable ?? false) %}
{% set viewEnabled = hideableColumns|length > 0 %}
{% set viewStorageKey = 'lr-table-view-' ~ pluginHandle ~ '-' ~ selectedSubnavItem %}

{# Pagination #}
{% set paginationConfig = config.pagination ?? {} %}
{% set page = paginationConfig.page ?? 1 %}
{% set limit = paginationConfig.limit ?? 50 %}
{% set totalCount = paginationConfig.totalCount ?? 0 %}
{% set offset = (page - 1) * limit %}
{% set totalPages = totalCount > 0 ? (totalCount / limit)|round(0, 'ceil') : 1 %}
{% set itemLabel = paginationConfig.itemLabel ?? {singular: 'item', plural: 'items'} %}

{# Checkboxes #}
{% set checkboxesEnabled = config.checkboxes ?? false %}

{# Row Actions - set to false to hide actions column #}
{% set rowActionsEnabled = config.rowActions ?? true %}

{# Actions #}
{% set footerActions = config.footerActions ?? [] %}
{% set newButton = config.newButton ?? null %}

{# AJAX refresh #}
{% set ajaxConfig = config.ajax ?? {} %}
{% set ajaxEnabled = ajaxConfig.enabled ?? false %}
{% set ajaxInterval = ajaxConfig.interval ?? 0 %}
{% set ajaxEndpoint = ajaxConfig.endpoint ?? '' %}

{# Build URL params for filter/sort/pagination links #}
{% set urlParams = {} %}
{% for filter in filters %}
    {% set urlParams = urlParams|merge({(filter.param): filter.current}) %}
{% endfor %}
{% set urlParams = urlParams|merge({
    search: searchValue,
    sort: currentSort,
    dir: currentDir
}) %}

{# Count columns for colspan #}
{% set colCount = columns|length + (checkboxesEnabled ? 1 : 0) %}


{# ============================================================================
   TOOLBAR BLOCK
   ============================================================================ #}

{% block toolbar %}
    <div id="toolbar" class="flex" style="align-items: flex-end;">
        <div class="flex-grow">
            <form method="get" action="{{ url(pluginHandle ~ '/' ~ selectedSubnavItem) }}" id="lr-filter-form">
                <div class="flex">
                    {# Render each filter #}
                    {% for filter in filters %}
                        {% if filter.type == 'status' %}
                            {% include 'lindemannrock-base/_components/filter-status' with {filter: filter, urlParams: urlParams} only %}
                        {% elseif filter.type == 'dropdown' %}
                            {% include 'lindemannrock-base/_components/filter-dropdown' with {filter: filter, urlParams: urlParams} only %}
                        {% elseif filter.type == 'dateRange' %}
                            {% include 'lindemannrock-base/_components/filter-daterange' with {filter: filter, urlParams: urlParams} only %}
                        {% endif %}
                    {% endfor %}

                    {# Extra toolbar items from plugin #}
                    {% block extraToolbar %}{% endblock %}

                    {# Search input #}
                    {% include 'lindemannrock-base/_components/search-input' with {
                        placeholder: searchPlaceholder,
                        value: searchValue,
                        filters: filters,
                        currentSort: currentSort,
                        currentDir: currentDir,
                    } only %}
                </div>
            </form>
        </div>

        {# Toolbar actions (outside form, e.g., Export button) #}
        {% block toolbarActions %}{% endblock %}

        {# View button (column visibility + sort) - using menubtn with disclosure-style content #}
        {% if viewEnabled %}
            <div class="btngroup">
                <button type="button" class="btn menubtn" data-icon="sliders" id="lr-view-btn">
                    {{ 'View'|t('app') }}
                </button>
                <div class="menu menu--disclosure lr-view-menu padded" id="lr-view-menu">
                    <div class="meta">
                        {# Sort By Section #}
                        {% if sortableColumns|length > 0 %}
                            <fieldset class="field sort-field">
                                <legend class="visually-hidden" data-label="{{ 'Sort by'|t('app') }}">{{ 'Sort by'|t('app') }}</legend>
                                <div class="heading"><legend>{{ 'Sort by'|t('app') }}</legend></div>
                                <div class="input">
                                    <div class="flex">
                                        <div class="flex-grow">
                                            <div class="select fullwidth">
                                                <select id="lr-sort-field" aria-label="{{ 'Sort attribute'|t('app') }}">
                                                    {% for col in sortableColumns %}
                                                        <option value="{{ col.key }}" {{ currentSort == col.key ? 'selected' : '' }}>
                                                            {{ col.label }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <section class="btngroup btngroup--exclusive" aria-label="{{ 'Sort direction'|t('app') }}">
                                            <button type="button" class="btn {{ currentDir == 'asc' ? 'active' : '' }}" title="{{ 'Sort ascending'|t('app') }}" aria-label="{{ 'Sort ascending'|t('app') }}" aria-pressed="{{ currentDir == 'asc' ? 'true' : 'false' }}" data-icon="asc" data-dir="asc"></button>
                                            <button type="button" class="btn {{ currentDir == 'desc' ? 'active' : '' }}" title="{{ 'Sort descending'|t('app') }}" aria-label="{{ 'Sort descending'|t('app') }}" aria-pressed="{{ currentDir == 'desc' ? 'true' : 'false' }}" data-icon="desc" data-dir="desc"></button>
                                        </section>
                                    </div>
                                </div>
                            </fieldset>
                        {% endif %}

                        {# Table Columns Section #}
                        {% if hideableColumns|length > 0 %}
                            <fieldset class="field table-columns-field">
                                <legend class="visually-hidden" data-label="{{ 'Table Columns'|t('app') }}">{{ 'Table Columns'|t('app') }}</legend>
                                <div class="heading"><legend>{{ 'Table Columns'|t('app') }}</legend></div>
                                <div class="input">
                                    <div class="checkbox-select">
                                        {% for col in hideableColumns %}
                                            <div class="checkbox-select-item">
                                                <input type="checkbox" value="{{ col.key }}" id="lr-col-{{ col.key }}" class="checkbox" checked>
                                                <label for="lr-col-{{ col.key }}">{{ col.label }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </fieldset>
                        {% endif %}
                    </div>
                    <div class="flex menu-footer">
                        <div class="flex-grow">
                            <button type="button" class="light" id="lr-view-defaults">{{ 'Use defaults'|t('app') }}</button>
                        </div>
                        <button type="button" class="btn" id="lr-view-close">{{ 'Close'|t('app') }}</button>
                    </div>
                </div>
            </div>
        {% endif %}

        {# New button #}
        {% if newButton and (not newButton.permission or currentUser.can(newButton.permission)) %}
            <a href="{{ newButton.url }}" class="btn submit add icon" id="lr-new-btn">
                <span class="lr-label-full">{{ newButton.label }}</span>
                <span class="lr-label-short" style="display: none;">{{ 'New'|t('app') }}</span>
            </a>
        {% endif %}
    </div>
{% endblock %}


{# ============================================================================
   CONTENT BLOCK
   ============================================================================ #}

{% block content %}
    {# Inline styles for this layout #}
    <style>
        .lr-checkbox-cell { width: 40px !important; text-align: center; }
        .page-info { margin: 0 12px; color: #596673; }
        .status-label { white-space: nowrap; }
        .pagination { gap: 4px; align-items: center; }
        .lr-menu-header { font-size: 11px; text-transform: uppercase; color: #7c97b2; padding: 8px 14px 4px; font-weight: 600; letter-spacing: 0.5px; }
        #toolbar.flex { flex-wrap: nowrap; gap: 8px; }
        #toolbar .flex-grow { min-width: 0; flex-shrink: 1; }
        .lr-clickable-row { cursor: pointer; transition: background 0.1s ease; }
        .lr-clickable-row:hover { background: #f9fafb !important; }
        .lr-context-row td { padding: 0 !important; }
        .lr-context-row .lr-context-content { padding: 16px; background: #f9fafb; border-left: 3px solid #3498db; }
        @media (max-width: 768px) {
            #lr-new-btn .lr-label-full { display: none; }
            #lr-new-btn .lr-label-short { display: inline !important; }
            #lr-new-btn:before { margin-inline-end: 0 !important; }
        }

        /* Info box wrapper (for warnings/notices before tables) */
        .info-box-table-wrapper { padding-bottom: 14px; }
        @media (min-width: 769px) {
            .info-box-table-wrapper { padding-bottom: 46px; }
        }

        /* Config info icon (shows tooltip on hover for config-defined items) */
        .config-info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 5px;
            border-radius: 50%;
            background: #9aa5b1;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            line-height: 16px;
            vertical-align: middle;
            cursor: help;
        }
        .config-info-icon::before { content: 'i'; }
        .config-info-icon:hover { background: #7b8794; }

        /* Config tooltip (shows PHP config code) */
        .config-tooltip {
            position: absolute;
            background: #fff;
            color: #3f4d5a;
            padding: 12px 14px;
            border-radius: 6px;
            border: 1px solid #cdd8e4;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre;
            z-index: 1000;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            max-width: 500px;
            overflow-x: auto;
        }

        /* View menu */
        .lr-view-menu { min-width: 280px; }

        /* Column visibility */
        .lr-column-hidden { display: none !important; }

        /* AJAX refresh notice - inline minimal style */
        .lr-refresh-notice {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 12px;
            padding-left: 12px;
            border-left: 1px solid #e3e5e8;
            cursor: default;
        }
        .lr-refresh-notice svg {
            width: 12px;
            height: 12px;
            opacity: 0.5;
        }
        .lr-refresh-notice.is-refreshing svg {
            opacity: 1;
            stroke: #10b981;
            animation: lr-spin 1s linear infinite;
        }
        @keyframes lr-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>

    {# Content before table (warnings, info boxes, etc.) #}
    {% block beforeTable %}{% endblock %}

    <div id="lr-table-container" class="elements">
        <div class="tableview tablepane">
            <table class="data fullwidth" id="lr-data-table">
                <thead>
                    <tr>
                        {# Checkbox header #}
                        {% if checkboxesEnabled %}
                            <th class="lr-checkbox-cell selectallcontainer">
                                <div class="checkbox" role="checkbox" tabindex="0" aria-checked="false" aria-label="{{ 'Select all'|t('app') }}"></div>
                            </th>
                        {% endif %}

                        {# Column headers #}
                        {% for column in columns %}
                            {% if column.sortable ?? false %}
                                <th scope="col"
                                    data-attribute="{{ column.key }}"
                                    data-column="{{ column.key }}"
                                    class="orderable {{ currentSort == column.key ? 'ordered ' ~ currentDir : '' }}{{ column.hideable ?? false ? ' lr-hideable-column' : '' }}"
                                    {% if column.width ?? false %}style="width: {{ column.width }};"{% endif %}>
                                    <button type="button" data-sort="{{ column.key }}">
                                        {{ column.label }}
                                    </button>
                                </th>
                            {% else %}
                                <th scope="col"
                                    data-column="{{ column.key }}"
                                    class="{{ column.hideable ?? false ? 'lr-hideable-column' : '' }}"
                                    {% if column.width ?? false %}style="width: {{ column.width }};"{% endif %}>
                                    {{ column.label }}
                                </th>
                            {% endif %}
                        {% endfor %}

                        {# Actions column header #}
                        {% if rowActionsEnabled %}
                            <th class="thin" style="width: 60px;">{{ 'Actions'|t('app') }}</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="lr-table-body">
                    {% if items|length %}
                        {% for item in items %}
                            {# Main row #}
                            <tr class="lr-data-row {% if expandableEnabled %}lr-clickable-row{% endif %}"
                                data-id="{{ item.id ?? loop.index }}"
                                data-entry-id="{{ loop.index }}">

                                {# Checkbox cell #}
                                {% if checkboxesEnabled %}
                                    <td class="lr-checkbox-cell">
                                        <div class="checkbox" title="{{ 'Select'|t('app') }}" tabindex="0" aria-checked="false" role="checkbox"></div>
                                    </td>
                                {% endif %}

                                {# Data cells - can be overridden #}
                                {% block tableRow %}
                                    {% for column in columns %}
                                        <td data-column="{{ column.key }}"
                                            class="{{ column.nowrap ?? false ? 'nowrap' : '' }}{{ column.hideable ?? false ? ' lr-hideable-column' : '' }}"
                                            {% if column.style ?? false %}style="{{ column.style }}"{% endif %}>
                                            {% if column.template ?? false %}
                                                {{ include(template_from_string(column.template)) }}
                                            {% else %}
                                                {{ attribute(item, column.key)|default('-') }}
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                {% endblock %}

                                {# Row actions (component outputs its own <td>) #}
                                {% if rowActionsEnabled %}
                                    {% block rowActions %}{% endblock %}
                                {% endif %}
                            </tr>

                            {# Expandable detail row #}
                            {% if expandableEnabled %}
                                <tr class="lr-context-row" data-entry-id="{{ loop.index }}" style="display: none;">
                                    <td colspan="{{ colCount + (rowActionsEnabled ? 1 : 0) }}">
                                        <div class="lr-context-content">
                                            {% block expandableRow %}{% endblock %}
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <tr class="lr-empty-row">
                            <td colspan="{{ colCount + (rowActionsEnabled ? 1 : 0) }}" style="text-align: center; padding: 2em;">
                                {{ emptyMessage }}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {# Footer #}
    <div id="footer" class="flex flex-justify">
        {# Pagination #}
        <div class="light">
            <div class="flex pagination">
                <nav class="flex" aria-label="{{ itemLabel.plural }} pagination">
                    <button type="button" class="page-link prev-page {{ page <= 1 ? 'disabled' : '' }}" {{ page <= 1 ? 'disabled' : '' }} title="{{ 'Previous Page'|t('app') }}"></button>
                    <button type="button" class="page-link next-page {{ page >= totalPages ? 'disabled' : '' }}" {{ page >= totalPages ? 'disabled' : '' }} title="{{ 'Next Page'|t('app') }}"></button>
                </nav>
                <div class="page-info">
                    {% set endRange = min(offset + limit, totalCount) %}
                    {% if totalCount == 0 %}
                        {{ 'no'|t('app') }} {{ itemLabel.plural }}
                    {% else %}
                        {{ (offset + 1)|number_format }} – {{ endRange|number_format }} {{ 'of'|t('app') }} {{ totalCount|number_format }} {{ totalCount == 1 ? itemLabel.singular : itemLabel.plural }}
                    {% endif %}
                    {# AJAX refresh notice (inline with page info) #}
                    {% if ajaxEnabled and ajaxInterval > 0 %}
                        <span class="lr-refresh-notice" id="lr-refresh-notice" title="{{ 'Auto-refresh'|t('app') }}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13.5 8a5.5 5.5 0 1 1-1.5-3.8M13.5 2v4h-4"/>
                            </svg>
                            <span class="lr-refresh-text"></span>
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Bulk actions container (shown when items selected) #}
        {% if checkboxesEnabled %}
            <div id="lr-bulk-actions" class="flex" style="display: none;">
                {% block bulkActions %}{% endblock %}
            </div>
        {% endif %}

        {# Footer actions #}
        {% if footerActions|length %}
            <div class="flex flex-nowrap">
                {% for action in footerActions %}
                    {% if (action.permission is not defined) or (not action.permission) or currentUser.can(action.permission) %}
                        {% if action.type == 'button' %}
                            <button type="button"
                                    class="btn {{ action.class ?? '' }}"
                                    id="{{ action.id ?? '' }}"
                                    {% if action.icon ?? false %}data-icon="{{ action.icon }}"{% endif %}>
                                {{ action.label }}
                            </button>
                        {% elseif action.type == 'link' %}
                            <a href="{{ action.url }}" class="btn {{ action.class ?? '' }}">
                                {{ action.label }}
                            </a>
                        {% elseif action.type == 'menu' %}
                            <div class="btngroup">
                                <button type="button" class="btn menubtn" {% if action.icon ?? false %}data-icon="{{ action.icon }}"{% endif %}>
                                    {{ action.label }}
                                </button>
                                <div class="menu" {% if action.align ?? false %}data-align="{{ action.align }}"{% endif %}>
                                    <ul>
                                        {% for menuItem in action.items %}
                                            <li>
                                                <a href="{{ menuItem.url ?? '#' }}"
                                                   {% if menuItem.id ?? false %}id="{{ menuItem.id }}"{% endif %}
                                                   {% if menuItem.class ?? false %}class="{{ menuItem.class }}"{% endif %}>
                                                    {{ menuItem.label }}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {# Extra footer content from plugin #}
                {% block extraFooter %}{% endblock %}
            </div>
        {% endif %}
    </div>

    {# JavaScript #}
    <script>
    (function() {
        const config = {
            ajaxEnabled: {{ ajaxEnabled ? 'true' : 'false' }},
            ajaxInterval: {{ ajaxInterval }},
            ajaxEndpoint: '{{ ajaxEndpoint }}',
            checkboxesEnabled: {{ checkboxesEnabled ? 'true' : 'false' }},
            currentSort: '{{ currentSort }}',
            currentDir: '{{ currentDir }}',
            page: {{ page }},
            totalPages: {{ totalPages }},
            urlParams: {{ urlParams|json_encode|raw }},
            baseUrl: '{{ url(pluginHandle ~ '/' ~ selectedSubnavItem) }}',
            viewEnabled: {{ viewEnabled ? 'true' : 'false' }},
            viewStorageKey: '{{ viewStorageKey }}',
            hideableColumns: {{ hideableColumns|map(c => c.key)|values|json_encode|raw }},
            columnKeys: {{ columns|map(c => c.key)|values|json_encode|raw }},
        };

        // Auto-assign data-column attributes based on column index
        // This ensures View button works even with custom tableRow blocks
        (function() {
            const startIndex = config.checkboxesEnabled ? 1 : 0;
            document.querySelectorAll('#lr-table-body .lr-data-row').forEach(row => {
                const cells = row.querySelectorAll('td');
                config.columnKeys.forEach((key, i) => {
                    const cell = cells[startIndex + i];
                    if (cell && !cell.hasAttribute('data-column')) {
                        cell.setAttribute('data-column', key);
                    }
                });
            });
        })();

        // Initialize menu buttons
        document.querySelectorAll('.menubtn').forEach(btn => {
            if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                new Craft.MenuBtn(btn);
            } else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
                new Garnish.MenuBtn(btn);
            }
        });

        // Clear search
        const clearBtn = document.querySelector('.lr-clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                const searchInput = document.querySelector('input[name="search"]');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.form.submit();
                }
            });
        }

        // Search on Enter
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    this.form.submit();
                }
            });
        }

        // Build URL with params
        function buildUrl(overrides = {}) {
            const params = new URLSearchParams(window.location.search);
            // Apply overrides
            for (const [key, value] of Object.entries(overrides)) {
                if (value !== null && value !== undefined && value !== '') {
                    params.set(key, value);
                } else {
                    params.delete(key);
                }
            }
            return window.location.pathname + '?' + params.toString();
        }

        // Sort buttons
        document.querySelectorAll('th.orderable button').forEach(button => {
            button.addEventListener('click', function() {
                const sortField = this.dataset.sort;
                let newDir = 'asc';
                if (sortField === config.currentSort) {
                    newDir = config.currentDir === 'asc' ? 'desc' : 'asc';
                }
                window.location.href = buildUrl({ sort: sortField, dir: newDir, page: 1 });
            });
        });

        // Pagination
        document.querySelector('.prev-page:not(.disabled)')?.addEventListener('click', function() {
            window.location.href = buildUrl({ page: config.page - 1 });
        });
        document.querySelector('.next-page:not(.disabled)')?.addEventListener('click', function() {
            window.location.href = buildUrl({ page: config.page + 1 });
        });

        // Checkbox functionality
        if (config.checkboxesEnabled) {
            const selectAllCheckbox = document.querySelector('.selectallcontainer .checkbox');
            const checkboxes = document.querySelectorAll('#lr-table-body .lr-data-row .checkbox');
            let selectedIds = new Set();

            function toggleCheckbox(checkbox, checked) {
                if (checked) {
                    checkbox.classList.add('checked');
                    checkbox.setAttribute('aria-checked', 'true');
                } else {
                    checkbox.classList.remove('checked');
                    checkbox.setAttribute('aria-checked', 'false');
                }
            }

            function updateBulkActions() {
                const bulkActions = document.getElementById('lr-bulk-actions');
                if (bulkActions) {
                    bulkActions.style.display = selectedIds.size > 0 ? '' : 'none';
                }
                // Dispatch custom event for plugins to listen to
                document.dispatchEvent(new CustomEvent('lr:selectionChanged', {
                    detail: { selectedIds: Array.from(selectedIds), count: selectedIds.size }
                }));
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('click', function() {
                    const isChecked = !this.classList.contains('checked');
                    toggleCheckbox(this, isChecked);
                    checkboxes.forEach(checkbox => {
                        toggleCheckbox(checkbox, isChecked);
                        const id = checkbox.closest('tr').dataset.id;
                        if (isChecked) {
                            selectedIds.add(id);
                        } else {
                            selectedIds.delete(id);
                        }
                    });
                    updateBulkActions();
                });
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation(); // Don't trigger row click
                    const isChecked = !this.classList.contains('checked');
                    toggleCheckbox(this, isChecked);
                    const id = this.closest('tr').dataset.id;
                    if (isChecked) {
                        selectedIds.add(id);
                    } else {
                        selectedIds.delete(id);
                    }
                    updateBulkActions();
                });
            });

            // Expose selection to global scope for plugins
            window.lrTableSelection = {
                getSelectedIds: () => Array.from(selectedIds),
                getCount: () => selectedIds.size,
                clear: () => {
                    selectedIds.clear();
                    document.querySelectorAll('.checkbox.checked').forEach(cb => toggleCheckbox(cb, false));
                    updateBulkActions();
                }
            };
        }

        // Expandable rows
        document.querySelectorAll('.lr-clickable-row').forEach(row => {
            row.addEventListener('click', function(e) {
                if (e.target.closest('.checkbox') || e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                const entryId = this.dataset.entryId;
                const contextRow = document.querySelector('.lr-context-row[data-entry-id="' + entryId + '"]');
                if (contextRow) {
                    const isVisible = contextRow.style.display !== 'none';
                    contextRow.style.display = isVisible ? 'none' : 'table-row';
                    this.style.background = isVisible ? '' : '#f0f4f8';
                }
            });
        });

        // AJAX Auto-refresh with subtle notice
        if (config.ajaxEnabled && config.ajaxInterval > 0) {
            let refreshTimer;
            let countdownTimer;
            let countdown = config.ajaxInterval;
            let isRefreshing = false;
            const noticeEl = document.getElementById('lr-refresh-notice');
            const textEl = noticeEl ? noticeEl.querySelector('.lr-refresh-text') : null;

            function formatTime(seconds) {
                if (seconds >= 60) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return secs > 0 ? mins + 'm ' + secs + 's' : mins + 'm';
                }
                return seconds + 's';
            }

            function updateNotice() {
                if (!noticeEl || !textEl) return;
                if (isRefreshing) {
                    noticeEl.classList.add('is-refreshing');
                    textEl.textContent = '{{ "Refreshing"|t("app") }}';
                } else {
                    noticeEl.classList.remove('is-refreshing');
                    textEl.textContent = formatTime(countdown);
                }
            }

            async function refresh() {
                if (isRefreshing) return;
                isRefreshing = true;
                updateNotice();

                try {
                    const params = new URLSearchParams(config.urlParams);
                    params.set('page', config.page);
                    const response = await fetch(config.ajaxEndpoint + '?' + params.toString(), {
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();

                    if (data.success) {
                        document.dispatchEvent(new CustomEvent('lr:refresh', { detail: data }));
                    }
                } catch (error) {
                    console.error('Refresh failed:', error);
                } finally {
                    isRefreshing = false;
                    countdown = config.ajaxInterval;
                    updateNotice();
                }
            }

            function tickCountdown() {
                if (!isRefreshing && countdown > 0) {
                    countdown--;
                    updateNotice();
                }
            }

            // Start auto-refresh
            updateNotice();
            refreshTimer = setInterval(refresh, config.ajaxInterval * 1000);
            countdownTimer = setInterval(tickCountdown, 1000);
        }

        // Config tooltip for config-based items (shows PHP config code on hover)
        let activeConfigTooltip = null;
        document.querySelectorAll('.config-info-icon').forEach(icon => {
            icon.addEventListener('mouseenter', function() {
                const configData = this.dataset.config;
                if (!configData) return;

                // Remove any existing tooltip
                if (activeConfigTooltip) {
                    activeConfigTooltip.remove();
                }

                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'config-tooltip';
                tooltip.textContent = configData;
                document.body.appendChild(tooltip);
                activeConfigTooltip = tooltip;

                // Position tooltip
                const rect = this.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                let left = rect.left + window.scrollX;
                let top = rect.bottom + window.scrollY + 8;

                // Keep within viewport
                if (left + tooltipRect.width > window.innerWidth - 20) {
                    left = window.innerWidth - tooltipRect.width - 20;
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            });

            icon.addEventListener('mouseleave', function() {
                if (activeConfigTooltip) {
                    activeConfigTooltip.remove();
                    activeConfigTooltip = null;
                }
            });
        });

        // View button functionality (column visibility + sort from menu)
        if (config.viewEnabled) {
            const viewBtn = document.getElementById('lr-view-btn');
            const viewMenu = document.getElementById('lr-view-menu');
            const sortSelect = document.getElementById('lr-sort-field');

            // After Garnish initializes, get the menu instance
            let $menu = null;
            setTimeout(function() {
                if (viewBtn.menubtn && viewBtn.menubtn.$menu) {
                    $menu = viewBtn.menubtn.$menu;

                    // Prevent menu close when clicking inside the menu content area
                    $menu.on('click mousedown', '.meta, .checkbox-select, .select, .btngroup, .field, select, option', function(e) {
                        e.stopPropagation();
                    });
                }
            }, 100);

            // Also handle select directly with native JS (backup)
            if (sortSelect) {
                sortSelect.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });
                sortSelect.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }

            // Close button
            const closeBtn = document.getElementById('lr-view-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Dispatch escape key to close menu properly
                    viewBtn.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape', keyCode: 27, bubbles: true}));
                });
            }

            // Use defaults button
            const defaultsBtn = document.getElementById('lr-view-defaults');
            if (defaultsBtn) {
                defaultsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem(config.viewStorageKey);
                    window.location.reload();
                });
            }

            // Sort field select
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    window.location.href = buildUrl({ sort: this.value, dir: config.currentDir, page: 1 });
                });
            }

            // Sort direction buttons
            document.querySelectorAll('.lr-view-menu .btngroup--exclusive button[data-dir]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const newDir = this.dataset.dir;
                    if (newDir !== config.currentDir) {
                        window.location.href = buildUrl({ sort: config.currentSort, dir: newDir, page: 1 });
                    }
                });
            });

            // Update sort dropdown when columns are hidden/shown
            function updateSortOptions() {
                if (!sortSelect) return;
                const hiddenColumns = getHiddenColumns();
                sortSelect.querySelectorAll('option').forEach(option => {
                    if (hiddenColumns.includes(option.value)) {
                        option.disabled = true;
                        option.style.display = 'none';
                    } else {
                        option.disabled = false;
                        option.style.display = '';
                    }
                });
                // If current sort column is now hidden, reset to first visible
                if (hiddenColumns.includes(sortSelect.value)) {
                    const firstVisible = sortSelect.querySelector('option:not([disabled])');
                    if (firstVisible) {
                        window.location.href = buildUrl({ sort: firstVisible.value, dir: config.currentDir, page: 1 });
                    }
                }
            }
            // Get stored view settings from localStorage
            function getStoredViewSettings() {
                try {
                    const stored = localStorage.getItem(config.viewStorageKey);
                    return stored ? JSON.parse(stored) : null;
                } catch (e) {
                    return null;
                }
            }

            // Save view settings to localStorage
            function saveViewSettings(settings) {
                try {
                    localStorage.setItem(config.viewStorageKey, JSON.stringify(settings));
                } catch (e) {
                    console.warn('Failed to save view settings:', e);
                }
            }

            // Toggle column visibility
            function toggleColumnVisibility(columnKey, visible) {
                const cells = document.querySelectorAll('[data-column="' + columnKey + '"]');
                cells.forEach(cell => {
                    if (visible) {
                        cell.classList.remove('lr-column-hidden');
                    } else {
                        cell.classList.add('lr-column-hidden');
                    }
                });
            }

            // Update colspan for empty row and expandable rows
            function updateColspans() {
                const visibleColumns = document.querySelectorAll('thead th:not(.lr-column-hidden)').length;
                document.querySelectorAll('.lr-empty-row td, .lr-context-row td').forEach(td => {
                    td.setAttribute('colspan', visibleColumns);
                });
            }

            // Apply stored settings on load
            function applyStoredSettings() {
                const settings = getStoredViewSettings();
                if (!settings) return;

                // Apply hidden columns
                if (settings.hiddenColumns && Array.isArray(settings.hiddenColumns)) {
                    settings.hiddenColumns.forEach(columnKey => {
                        toggleColumnVisibility(columnKey, false);
                        // Uncheck the checkbox in the menu
                        const checkbox = document.getElementById('lr-col-' + columnKey);
                        if (checkbox) checkbox.checked = false;
                    });
                    updateColspans();
                }
            }

            // Get current hidden columns from checkboxes
            function getHiddenColumns() {
                const hidden = [];
                config.hideableColumns.forEach(columnKey => {
                    const checkbox = document.getElementById('lr-col-' + columnKey);
                    if (checkbox && !checkbox.checked) {
                        hidden.push(columnKey);
                    }
                });
                return hidden;
            }

            // Initialize column checkboxes (using Craft's checkbox-select-item class)
            document.querySelectorAll('.lr-view-menu .checkbox-select-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const columnKey = this.value;
                    const visible = this.checked;
                    toggleColumnVisibility(columnKey, visible);
                    updateColspans();
                    updateSortOptions();

                    // Save settings
                    saveViewSettings({
                        hiddenColumns: getHiddenColumns()
                    });
                });
            });

            // Apply stored settings on page load
            applyStoredSettings();
            updateSortOptions();

            // Expose view functions globally
            window.lrViewSettings = {
                get: getStoredViewSettings,
                save: saveViewSettings,
                toggleColumn: toggleColumnVisibility,
                getHiddenColumns: getHiddenColumns,
                reset: function() {
                    localStorage.removeItem(config.viewStorageKey);
                    location.reload();
                }
            };
        }

        // Expose config globally for plugins
        window.lrTableConfig = config;
        window.lrBuildUrl = buildUrl;
    })();
    </script>

    {# Plugin-specific scripts #}
    {% block scripts %}{% endblock %}
{% endblock %}


{# ============================================================================
   SIDEBAR/DETAILS BLOCK
   Note: We use 'sidebarContent' instead of 'sidebar' to avoid collision
   with Craft's left sidebar block in _layouts/cp
   ============================================================================ #}

{% block details %}
    {% block sidebarContent %}{% endblock %}
{% endblock %}
