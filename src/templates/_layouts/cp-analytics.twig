{#
 # CP Analytics Layout
 #
 # A reusable layout for Control Panel analytics/dashboard pages.
 # Provides unified toolbar, tabs, stat boxes, charts, and date filtering.
 #
 # Usage in plugin template:
 # ┌──────────────────────────────────────────────────────────────────┐
 # │ {% extends 'lindemannrock-base/_layouts/cp-analytics' %}         │
 # │                                                                  │
 # │ {% set analyticsConfig = {                                       │
 # │     plugin: {                                                   │
 # │         handle: 'sms-manager',                                  │
 # │         name: smsHelper.fullName,                               │
 # │     },                                                          │
 # │     page: {                                                     │
 # │         title: 'Analytics',                                     │
 # │         subnav: 'analytics',                                    │
 # │         crumbs: [...],                                          │
 # │     },                                                          │
 # │     tabs: {                                                     │
 # │         overview: { label: 'Overview' },                        │
 # │         details: { label: 'Details' },                          │
 # │     },                                                          │
 # │     filters: {                                                  │
 # │         dateRange: { default: 'last7days', current: dateRange },│
 # │         sites: { enabled: true, current: siteId, sites: sites },│
 # │         custom: [                                               │
 # │             { param: 'provider', current: providerId, ... },    │
 # │         ],                                                      │
 # │     },                                                          │
 # │     export: {                                                   │
 # │         permission: 'smsManager:exportAnalytics',               │
 # │         action: 'sms-manager/analytics/export',                 │
 # │     },                                                          │
 # │     charts: {                                                   │
 # │         library: 'chartjs',  // 'chartjs' or 'uplot' (future)   │
 # │         prefix: 'sms',       // Window prefix for chart instances│
 # │         dataEndpoint: 'sms-manager/analytics/get-data',         │
 # │     },                                                          │
 # │ } %}                                                            │
 # └──────────────────────────────────────────────────────────────────┘
 #
 # Overridable blocks:
 # - {% block tabs %} - Tab content (each tab has its own div)
 # - {% block tabContent_[tabId] %} - Content for specific tab
 # - {% block extraToolbar %} - Additional toolbar items
 # - {% block actionButton %} - Action button area (export, etc.)
 # - {% block scripts %} - Additional JavaScript
 # - {% block chartInit %} - Chart initialization (plugin-specific)
 # - {% block chartRender %} - Chart rendering functions
 #}

{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{# Register Chart.js and analytics helpers asset bundle #}
{% do view.registerAssetBundle('lindemannrock\\base\\web\\assets\\analytics\\AnalyticsAsset') %}

{# ============================================================================
   CONFIGURATION EXTRACTION
   ============================================================================ #}

{% set config = analyticsConfig ?? {} %}

{# Plugin info #}
{% set pluginConfig = config.plugin ?? {} %}
{% set pluginHandle = pluginConfig.handle ?? '' %}
{% set pluginName = pluginConfig.name ?? '' %}

{# Page info #}
{% set pageConfig = config.page ?? {} %}
{% set title = pageConfig.title ?? 'Analytics'|t('app') %}
{% set selectedSubnavItem = pageConfig.subnav ?? 'analytics' %}
{% set crumbs = pageConfig.crumbs ?? [] %}

{# Tabs #}
{% set tabsConfig = config.tabs ?? {} %}
{% set selectedTab = 'overview' %}

{# Build tabs with hash URLs #}
{% set tabs = {} %}
{% for tabId, tab in tabsConfig %}
    {% set tabs = tabs|merge({
        (tabId): {
            label: tab.label,
            url: '#' ~ tabId,
        }
    }) %}
{% endfor %}

{# Filters #}
{% set filtersConfig = config.filters ?? {} %}

{# Date range filter #}
{% set dateRangeConfig = filtersConfig.dateRange ?? {} %}
{% set dateRangeDefault = dateRangeConfig.default ?? 'last7days' %}
{% set dateRange = dateRangeConfig.current ?? craft.app.request.getParam('dateRange', dateRangeDefault) %}

{# Date range options #}
{% set dateRangeOptions = {
    'today': 'Today'|t('app'),
    'yesterday': 'Yesterday'|t('app'),
    'last7days': 'Last 7 days'|t('app'),
    'last30days': 'Last 30 days'|t('app'),
    'last90days': 'Last 90 days'|t('app'),
    'all': 'All time'|t('app'),
} %}

{# Site filter #}
{% set siteFilterConfig = filtersConfig.sites ?? {} %}
{% set siteFilterEnabled = siteFilterConfig.enabled ?? false %}
{% set currentSiteId = siteFilterConfig.current ?? craft.app.request.getParam('siteId', '') %}
{% set sites = siteFilterConfig.sites ?? [] %}

{# Custom filters #}
{% set customFilters = filtersConfig.custom ?? [] %}

{# Export config #}
{% set exportConfig = config.export ?? {} %}
{% set exportPermission = exportConfig.permission ?? null %}
{% set exportAction = exportConfig.action ?? '' %}
{% set canExport = exportPermission ? currentUser.can(exportPermission) : false %}

{# Build export params from filters #}
{% set exportParams = {} %}
{% if currentSiteId %}
    {% set exportParams = exportParams|merge({siteId: currentSiteId}) %}
{% endif %}
{% for filter in customFilters %}
    {% if filter.current and filter.current != 'all' %}
        {% set exportParams = exportParams|merge({(filter.param): filter.current}) %}
    {% endif %}
{% endfor %}

{# Charts config #}
{% set chartsConfig = config.charts ?? {} %}
{% set chartLibrary = chartsConfig.library ?? 'chartjs' %}
{% set chartPrefix = chartsConfig.prefix ?? 'analytics' %}
{% set chartDataEndpoint = chartsConfig.dataEndpoint ?? '' %}


{# ============================================================================
   ACTION BUTTON (Export)
   ============================================================================ #}

{% block actionButton %}
    {% if canExport and exportAction %}
        <div id="action-button">
            {% include 'lindemannrock-base/_components/export-menu' with {
                action: exportAction,
                extraParams: exportParams,
            } only %}
        </div>
    {% endif %}
{% endblock %}


{# ============================================================================
   TOOLBAR BLOCK
   ============================================================================ #}

{% block toolbar %}
    <div class="flex">
        {# Custom filters (provider, etc.) #}
        {% for filter in customFilters %}
            {% if filter.options|length > 1 %}
                <div>
                    <div class="btngroup">
                        <button type="button" class="btn menubtn">
                            <span id="{{ filter.param }}Label">
                                {% set currentOption = filter.options|filter(o => o.value == filter.current)|first %}
                                {{ currentOption.label ?? filter.allLabel ?? 'All'|t('app') }}
                            </span>
                        </button>
                        <div class="menu">
                            <ul>
                                {% for option in filter.options %}
                                    <li>
                                        <a href="#"
                                           data-{{ filter.param }}="{{ option.value }}"
                                           class="lr-custom-filter-option {{ filter.current == option.value ? 'sel' : '' }}"
                                           data-param="{{ filter.param }}">
                                            {{ option.label }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}

        {# Site filter #}
        {% if siteFilterEnabled and sites|length > 1 %}
            <div>
                <div class="btngroup">
                    <button type="button" class="btn menubtn">
                        <span id="siteLabel">
                            {{ currentSiteId ? sites|filter(s => s.id == currentSiteId)|first.name : 'All Sites'|t('app') }}
                        </span>
                    </button>
                    <div class="menu">
                        <ul>
                            <li><a href="#" data-site="" class="lr-site-option {{ not currentSiteId ? 'sel' : '' }}">{{ "All Sites"|t('app') }}</a></li>
                            {% for site in sites %}
                                <li><a href="#" data-site="{{ site.id }}" class="lr-site-option {{ currentSiteId == site.id ? 'sel' : '' }}">{{ site.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}

        {# Date range filter #}
        <div>
            <div class="btngroup">
                <button type="button" class="btn menubtn">
                    <span id="dateRangeLabel">{{ dateRangeOptions[dateRange] ?? dateRangeOptions['last7days'] }}</span>
                </button>
                <div class="menu">
                    <ul>
                        {% for value, label in dateRangeOptions %}
                            <li><a href="#" data-range="{{ value }}" class="lr-date-range-option {{ dateRange == value ? 'sel' : '' }}">{{ label }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        {# Extra toolbar items from plugin #}
        {% block extraToolbar %}{% endblock %}
    </div>
{% endblock %}


{# ============================================================================
   CONTENT BLOCK
   ============================================================================ #}

{% block content %}
    {# Styles #}
    <style>
        /* Tab content */
        .lr-tab-content {
            padding: 24px;
        }

        /* Stat boxes grid */
        .lr-analytics-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        /* Individual stat box */
        .lr-stat-box {
            background: #f3f7fc;
            padding: 24px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--hairline-color, #e3e5e8);
        }

        .lr-stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #0d78f2;
            margin-bottom: 8px;
        }

        .lr-stat-label {
            font-size: 14px;
            color: #596673;
        }

        /* Charts grid */
        .lr-analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .lr-analytics-charts.two-columns {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (max-width: 1024px) {
            .lr-analytics-charts.two-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Chart container */
        .lr-chart-container {
            background: #fff;
            border: 1px solid #e3e5e8;
            border-radius: 4px;
            padding: 24px;
            min-width: 0;
            overflow: hidden;
        }

        .lr-chart-container.full-width {
            grid-column: 1 / -1;
        }

        .lr-chart-container h3 {
            margin: 0 0 20px;
            font-size: 16px;
        }

        .lr-chart-container canvas {
            max-height: 300px;
            max-width: 100%;
        }

        .lr-chart-container > canvas {
            display: block;
            box-sizing: border-box;
        }

        /* Section headings */
        .lr-section-heading {
            margin: 30px 0 20px;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        /* Table scroll container */
        .lr-table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -24px;
            padding: 0 24px;
        }

        .lr-table-scroll table {
            min-width: 100%;
            width: 100%;
        }

        @media (max-width: 768px) {
            .lr-table-scroll {
                margin: 0 -12px;
                padding: 0 12px;
            }
        }

        /* Loading state */
        .lr-chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #9ca3af;
        }

        /* Empty state */
        .lr-chart-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
    </style>

    {# Tab Content - Plugin defines the content #}
    {% block tabs %}
        {# Override this block to define tab content #}
        {# Example:
        <div id="overview" class="lr-tab-content">
            {% include 'my-plugin/analytics/_partials/overview' %}
        </div>
        <div id="details" class="lr-tab-content hidden">
            {% include 'my-plugin/analytics/_partials/details' %}
        </div>
        #}
    {% endblock %}

    {# Plugin credit #}
    {% include 'lindemannrock-base/_components/plugin-credit' %}

    {# JavaScript - Page-specific initialization #}
    <script>
    (function() {
        'use strict';

        // Page configuration
        var config = {
            prefix: '{{ chartPrefix }}',
            dataEndpoint: '{{ chartDataEndpoint ? actionUrl(chartDataEndpoint) : '' }}',
            dateRange: '{{ dateRange }}',
            siteId: '{{ currentSiteId }}',
            csrfToken: '{{ craft.app.request.csrfToken }}',
            csrfName: '{{ craft.app.config.general.csrfTokenName }}',
            tabs: {{ tabsConfig|keys|json_encode|raw }}
        };

        // Tab state
        window.currentTab = config.tabs[0] || 'overview';

        // Tab Switching
        function switchTab(tabId) {
            if (!tabId || config.tabs.indexOf(tabId) === -1) {
                tabId = config.tabs[0] || 'overview';
            }

            document.querySelectorAll('.lr-tab-content').forEach(function(el) {
                el.classList.add('hidden');
            });

            var targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }

            window.currentTab = tabId;

            document.dispatchEvent(new CustomEvent('lr:tabChanged', {
                detail: { tabId: tabId }
            }));
        }

        // Handle hash changes
        window.addEventListener('hashchange', function() {
            switchTab(window.location.hash.substring(1));
        });

        // Document ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize menu buttons
            document.querySelectorAll('.menubtn').forEach(function(btn) {
                if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                    new Craft.MenuBtn(btn);
                } else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
                    new Garnish.MenuBtn(btn);
                }
            });

            // Handle tab link clicks
            document.addEventListener('click', function(e) {
                var link = e.target.closest('a[href^="#"]');
                if (link) {
                    setTimeout(function() {
                        switchTab(window.location.hash.substring(1));
                    }, 10);
                }
            });

            // Initial tab
            switchTab(window.location.hash.substring(1) || config.tabs[0] || 'overview');

            // Date Range Handler
            document.addEventListener('click', function(e) {
                var option = e.target.closest('.lr-date-range-option');
                if (option) {
                    e.preventDefault();
                    var url = new URL(window.location);
                    url.searchParams.set('dateRange', option.dataset.range);
                    window.location = url;
                }
            });

            // Site Filter Handler
            document.addEventListener('click', function(e) {
                var option = e.target.closest('.lr-site-option');
                if (option) {
                    e.preventDefault();
                    var url = new URL(window.location);
                    if (option.dataset.site) {
                        url.searchParams.set('siteId', option.dataset.site);
                    } else {
                        url.searchParams.delete('siteId');
                    }
                    window.location = url;
                }
            });

            // Custom Filter Handler
            document.addEventListener('click', function(e) {
                var option = e.target.closest('.lr-custom-filter-option');
                if (option) {
                    e.preventDefault();
                    var param = option.dataset.param;
                    var value = option.dataset[param];
                    var url = new URL(window.location);
                    if (value && value !== 'all') {
                        url.searchParams.set(param, value);
                    } else {
                        url.searchParams.delete(param);
                    }
                    window.location = url;
                }
            });

            // Initialize analytics with config (triggers lr:analyticsInit event)
            if (typeof window.lrAnalyticsInit === 'function') {
                window.lrAnalyticsInit(config);
            }
        });
    })();
    </script>

    {# Plugin-specific scripts #}
    {% block scripts %}{% endblock %}
{% endblock %}
